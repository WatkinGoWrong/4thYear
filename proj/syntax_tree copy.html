<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <style>
        #c1, c2, c3 {
            fill:black;
        }

        #left {
        	border-radius: 12px;
		    background-color: #4CAF50;
		    border: none;
		    color: white;
		    padding: 8px 16px;
		    text-align: center;
		    text-decoration: none;
		    display: inline-block;
		    font-size: 10px;
		    margin: 2px 2px;
		    cursor: pointer;
		}

		#right {
			border-radius: 12px;
		    background-color: #94618e;
		    border: none;
		    color: white;
		    padding: 8px 16px;
		    text-align: center;
		    text-decoration: none;
		    display: inline-block;
		    font-size: 10px;
		    margin: 2px 2px;
		    cursor: pointer;
		}

		#svgTree,#svgTree-two{
			border:1px solid black;
		}
    </style>

</head>
<body>

<div style="width: 80%; display: table;">
    <div style="display: table-row">
 
	<div class = "tree-one">
	    <script class ="js-tree-one" ">

	        function tree () {

	        	var devide = 2;

	            var svgWidth = 1200/2,
	                svgHeight = 600/2;

	            var tree = {
	                cx: 600/2,
	                cy: 30/2,
	                w: 100,
	                h: 60/1.5,
	                size: 1/2,
	                leafDepth: Infinity,
	                nodes: []
	            };

	            var uniformDepth = true;
	            var addNode = false;
	            var removeNode = false;
	            var changeText = false;
	            var svgNodes;

	            var JSONData;

	          
	            //get the nodes
	            tree.getNodes = function () {
	                var n = [];
	                function getNodes(node) {
	                    n.push({ id: node.id, text: node.text, x: node.x, y: node.y, kids: node.kids, isLeaf: node.isLeaf, tWidth: node.tWidth });
	                    node.kids.forEach(function (kid) { return getNodes(kid); });
	                }
	                getNodes(tree.nodes[0]);
	                return n.sort(function (a, b) { return a.id - b.id; });
	            }

	            //get the links
	            tree.getLinks = function () {
	                var l = [];
	                function getLinks(node) {
	                    node.kids.forEach(function (kid) { if (!kid.isLeaf) { l.push({ fromId: node.id, fromX: node.x, fromY: node.y, toId: kid.id, toX: kid.x, toY: kid.y }); } });
	                    node.kids.forEach(getLinks);
	                }
	                getLinks(tree.nodes[0]);
	                return l.sort(function (a, b) { return a.toId - b.toId });
	            }

	            //get the triangles -- size of the trees
	            tree.getTriangles = function () {
	                var t = [];
	                function getTriangles(node) {
	                    node.kids.forEach(function (kid) { if (kid.isLeaf) { t.push({ fromId: node.id, toId: kid.id, topX: node.x, topY: (node.y + 10/2), leftX: (kid.x - (kid.tWidth / 4)), leftY: (kid.y - 10/2), rightX: (kid.x + (kid.tWidth / 4)), rightY: (kid.y - 10/2) }); } });//10
	                    node.kids.forEach(getTriangles);
	                }
	                getTriangles(tree.nodes[0]);
	                return t.sort(function (a, b) { return a.toId - b.toId });
	            }

	            //returns node object from nodes array
	            tree.getNode = function (thisNode) {
	                var n;
	                //console.log('thisNode');
	                //console.log(thisNode);
	                function getNode(node) {
	                    if (node.id == thisNode.id) { n = node; }
	                    node.kids.forEach(getNode);
	                }
	                getNode(tree.nodes[0]);
	                //console.log('n');
	                //console.log(n);
	                return n;
	            }

	            //get text width of node
	/*            tree.getTextWidth = function (node) {
	                var n = tree.getNode(node);
	                var nodes = d3.select('text#' + n.id);
	                n.tWidth = nodes.node().getBBox().width;
	                return nodes.node().getBBox().width;
	            }
	*/
	            //add a new leaf
	            tree.addLeaf = function (parent) {
	                tree.size++;
	                function addLeaf(node) {
	                    if (node.id == parent) {
	                        console.log('id' + (tree.size - 1)); node.kids.push({ id: 'id' + (tree.size - 1), text: 'Node ' + (tree.size - 1), x: node.x, y: node.y, kids: [], isLeaf: true, tWidth: 0 }); node.isLeaf = false;
	                        refresh();
	                        reposition(tree.nodes[0]);
	                        redraw(); return;
	                    }
	                    node.kids.forEach(addLeaf);
	                }
	                addLeaf(tree.nodes[0]);
	//                reposition(tree.nodes[0]);
	//                redraw();
	            }

	            //remove leaf
	            tree.removeLeaf = function (nodeClicked) {
	                var parent = tree.nodes[0];
	                var visited = [];
	                function removeLeaf(p) {
	                    function arrangeKids(index, numOfKids) {
	                        parent.kids.splice(index, 1);
	                        if (parent.kids.length == 0) { parent.isLeaf = true; }

	                        //console.log(parent.kids);

	                    }
	                    if (p.id == parent.id) {
	                        for (var i = 0; i < parent.kids.length; i++) {
	                            if (parent.kids[i].id == nodeClicked.id) {
	                                arrangeKids(i, parent.kids.length);
	                                reposition(tree.nodes[0]);
	                                redraw();
	                                return;
	                            }
	                        }
	                    }
	                    p.kids.forEach(removeLeaf);
	                }
	                function findParent(node) { //finds the parent object of the leaf clicked and saves it to parent variable
	                    visited.push(node);
	                    if (node.id == nodeClicked.id) { visited.pop(); parent = visited[visited.length - 1]; removeLeaf(tree.nodes[0]); }
	                    else {
	                        node.kids.forEach(findParent);
	                        visited.pop(); //remove nodes down visited paths
	                    }

	                    //console.log(visited);
	                }

	                if (nodeClicked.isLeaf) {
	                    findParent(tree.nodes[0]);
	                }
	                refresh();
	                reposition(tree.nodes[0]);
	                redraw();
	            }

	            //change node text
	            tree.changeText = function (node) {
	                var newText = '';
	                var num = 0;
	                var textBox = d3.select("#nodes").append("foreignObject").attr("x", node.x + 50).attr("y", node.y)
	                                .attr("width", 200).attr("height", 25).append("xhtml:form")
	                                .append("input").attr("value", function () { this.focus(); return node.text })
	                                .on("blur", function () {
	                                    newText = textBox.node().value;
	                                    function changeText(n) {
	                                        if (n.id == node.id) {
	                                            n.text = newText;
	                                            /*var nodes = d3.select('text#' + n.id);
	                                            nodes.text(newText);
	                                            //tree.getTextWidth(n);
	                                            nodes.attr('tWidth', tree.getTextWidth(n));
	                                            reposition(tree.nodes[0]);
	                                            */
	                                            refresh();
	                                            redraw();
	                                           return;
	                                        }
	                                        n.kids.forEach(changeText);
	                                    }
	                                    changeText(tree.nodes[0]);
	                                    redraw();
	                                    d3.select("foreignObject").remove();
	                                    
	                                })
	                                .on("keypress", function () { 
	                                    if (d3.event.keyCode == 13) {
	                                        var e = d3.event;
	                                        //prevents the entire tree from deleting when enter is pressed
	                                        if (e.stopPropagation) { e.stopPropagation(); }
	                                        e.preventDefault();

	                                        newText = textBox.node().value;
	                                        function changeText(n) {
	                                            if (n.id == node.id) {
	                                                n.text = newText;
	                                                /*var nodes = d3.select('text#' + n.id);
	                                                nodes.text(newText);
	                                                //tree.getTextWidth(n);
	                                                nodes.attr('tWidth', tree.getTextWidth(n));
	                                                reposition(tree.nodes[0]);
	                                                */
	                                                refresh();
	                                                redraw();
	                                                return;
	                                            }
	                                            n.kids.forEach(changeText);
	                                        }
	                                        changeText(tree.nodes[0]);
	                                        redraw();
	                                        d3.select("foreignObject").remove();
	                                    }
	                                });
	                //tree.getTextWidth(node);
	            }

	            //sets leafs depth to deepest leaf
	            tree.nodeDepth = function () {
	                var leafs = [];
	                var depth = 0;
	                
	                //check if nodes are leafs
	                function nodeDepth(n) {
	                    n.kids.forEach(function (kid) {
	                        if (kid.isLeaf) { leafs.push({ id: kid.id });
	                            if (kid.y > depth) { depth = kid.y; }
	                        }
	                    });
	                    n.kids.forEach(nodeDepth);
	                }
	                nodeDepth(tree.nodes[0]);
	                function changeDepth(n) {
	                    n.kids.forEach(function (kid) {
	                        leafs.forEach(function (leaf) { if (kid.id == leaf.id) { kid.y = depth; } })
	                        
	                    });
	                    n.kids.forEach(changeDepth);
	                }
	                changeDepth(tree.nodes[0]);
	                tree.leafDepth = depth;
	            }

	            //update/refresh svg
	            refresh = function () {
	                d3.select('#nodes').selectAll('text').data(tree.getNodes()).remove();
	                d3.select('#links').selectAll('line').data(tree.getLinks()).remove();
	                d3.select('#triangles').selectAll('polygon').data(tree.getTriangles()).remove();
	            }

	            //redraw the tree
	            redraw = function () {
	                d3.select('#nodes').selectAll('text').data(tree.getNodes()).exit().remove();
	                d3.select('#links').selectAll('line').data(tree.getLinks()).exit().remove();
	                d3.select('#triangles').selectAll('polygon').data(tree.getTriangles()).exit().remove();
	  
	                var nodes = d3.select('#nodes').selectAll('text').data(tree.getNodes());

	                nodes.text(function (node) { return node.text })/*.transition().duration(500)*/
	                    .attr('x', function (node) { return node.x; }).attr('y', function (node) { return node.y + 5; })//5
	                    .attr('fill', function (node) { if (node.isLeaf) { return 'red'; } else { return 'blue'; } });

	                nodes.enter().append('text').attr('id', function (node) { console.log('id = ' + node.id); return node.id; })
	                    .attr('x', function (node) { return node.x; }).attr('y', function (node) { return node.y + 5; })
	                    .text(function (node) { return node.text; }) 
	                    .attr('tWidth', function (node) {
	                        var n = tree.getNode(node); n.tWidth = this.getBBox().width; return this.getBBox().width;
	                    })
	                    .style({ 'text-anchor': 'middle', 'cursor': 'pointer' })
	                    .on('click', function (node) { if (d3.event.shiftKey) { return tree.changeText(node); } else if (d3.event.ctrlKey) { return tree.removeLeaf(node); } else { return tree.addLeaf(node.id); } })
	                    /*.transition().duration(500)*/
	                    .attr('x', function (node) { return node.x; }).attr('y', function (node) { return node.y + 5; });


	                var links = d3.select('#links').selectAll('line').data(tree.getLinks());

	                links/*.transition().duration(500)*/
	                    .attr('x1', function (link) { return link.fromX; }).attr('y1', function (link) { return link.fromY + 10; })//10
	                    .attr('x2', function (link) { return link.toX; }).attr('y2', function (link) { return link.toY - 10; });

	                links.enter().append('line')
	                    .attr('x1', function (link) { return link.fromX; }).attr('y1', function (link) { return link.fromY + 10; })
	                    .attr('x2', function (link) { return link.toX; }).attr('y2', function (link) { return link.toY - 10; })
	                    .style({ 'stroke': 'black', 'stroke-width': '1px' })
	                    /*.transition().duration(500)*/
	                    .attr('x2', function (link) { return link.toX; }).attr('y2', function (link) { return link.toY - 10; });

	                    
	                var triangles = d3.select('#triangles').selectAll('polygon').data(tree.getTriangles());

	                triangles/*.transition().duration(500)*/
	                    .attr('points', function (triangle) { return (triangle.topX + ',' + triangle.topY + ' ' + triangle.leftX + ',' + triangle.leftY + ' ' + triangle.rightX + ',' + triangle.rightY) });

	                triangles.enter().append('polygon')
	                    .attr('points', function (triangle) { return (triangle.topX + ',' + triangle.topY + ' ' + triangle.leftX + ',' + triangle.leftY + ' ' + triangle.rightX + ',' + triangle.rightY) })
	                    .style({ 'stroke': 'black', 'stroke-width': '1px', 'fill': 'white' })
	                    /*.transition().duration(500)*/
	                    .attr('points', function (triangle) { return (triangle.topX + ',' + triangle.topY + ' ' + triangle.leftX + ',' + triangle.leftY + ' ' + triangle.rightX + ',' + triangle.rightY) });
	            }

	            //get leaf count for node
	            getLeafCount = function (node) {
	                if (node.kids.length == 0) { return 1; }
	                else { return node.kids.map(getLeafCount).reduce(function (a, b) { return a + b; }); }
	            }

	            //update node positions
	            reposition = function (node) {

	                if (uniformDepth) {
	                    tree.nodeDepth();
	                }

	                var leafCount = getLeafCount(node),
	                    left = node.x - tree.w * (leafCount - 1) / 2;
	                node.kids.forEach(function (kid) {
	                    var w = tree.w * getLeafCount(kid);
	                    left += w;
	                    kid.x = left - (w + tree.w) / 2;
	                    kid.y = node.y + tree.h;
	                    reposition(kid);
	                    redraw();
	                });
	                
	            }

	            //convert svgTree to image 
	            svgToImage = function () {
	                //get svg element.
	                var svg = d3.select("svg")[0][0];
	                
	                //'remove' the legend in the top left corner
	                d3.select('text#c1').attr('style', 'fill:white;');
	                d3.select('text#c2').attr('style', 'fill:white;');
	                d3.select('text#c3').attr('style', 'fill:white;');

	                //get svg source.
	                var serializer = new XMLSerializer();
	                var source = serializer.serializeToString(svg);

	                //add name spaces.
	                if (!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)) {
	                    source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
	                }
	                if (!source.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)) {
	                    source = source.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
	                }

	                //add xml declaration
	                source = '<?xml version="1.0" standalone="no"?>\r\n' + source;

	                //convert svg source to URI data scheme.
	                var url = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(source);

	                //open the image in a new tab
	                var win = window.open(url, '_blank');

	                //make the legned visible again
	                d3.select('text#c1').attr('style', 'font-size:6; fill:black;');
	                d3.select('text#c2').attr('style', 'font-size:6; fill:black;');
	                d3.select('text#c3').attr('style', 'font-size:6; fill:black;');

	                win.focus();
	            }

	            //save the tree structure as JSON
	            saveTree = function () {
	                console.log(tree.nodes);
	                JSONData = JSON.stringify(tree.nodes);
	                console.log(JSONData);
	            }

	            //save the tree structure as JSON
	            loadTree = function () {
	                tree.nodes = JSON.parse(JSONData);
	                console.log(tree.nodes);
	                refresh();
	                reposition(tree.nodes[0]);
	                redraw();
	            }

	            resetTree = function () {
	                tree.nodes = [];
	                tree.nodes.push({ id: '00', text: 'Tree Left', x: tree.cx, y: tree.cy, kids: [], isLeaf: false, tWidth: 0 });
	                console.log(tree.nodes);
	                refresh();
	                reposition(tree.nodes[0]);
	                redraw();
	            }

	            //set up the page
	            initialise = function () {


	                //add the root node
	                tree.nodes.push({ id: '00', text: 'Left Tree', x: tree.cx, y: tree.cy, kids: [], isLeaf: false, tWidth: 0 });

	                //create the svg
	                d3.select(".tree-one").style().append('svg').attr('width', svgWidth).attr('height', svgHeight).attr('id', 'svgTree')
	                    ;

	                //create group of nodes
	                d3.select('#svgTree').append('g').attr('id', 'nodes').selectAll('text').data(tree.getNodes())
	                    .enter().append('text').attr('id', function (node) { return node.id; })
	                    .attr('x', function (node) { return node.x; }).attr('y', function (node) { return node.y + 5; })
	                    .text(function (node) { return node.text; })
	                    .attr('tWidth', function (node) { var n = tree.getNode(node); n.tWidth = this.getBBox().width; return this.getBBox().width; /*return tree.getTextWidth(node);*/ })
	                    .style({ 'text-anchor': 'middle', 'cursor': 'pointer' })
	                    .on('click', function (node) { return tree.addLeaf(node.id); });

	                //create group of links
	                d3.select('#svgTree').append('g').attr('id', 'links').selectAll('line').data(tree.getLinks())
	                    .enter().append('line')
	                    .attr('x1', function (link) { return link.fromX; }).attr('y1', function (link) { return link.fromY; })
	                    .attr('x2', function (link) { return link.toX; }).attr('y2', function (link) { return link.toY; });
	       
	                //create group of triangles
	                d3.select('#svgTree').append('g').attr('id', 'triangles').selectAll('polygon').data(tree.getTriangles())
	                    .enter().append('polygon')
	                    .attr('points', function (triangle) { return (triangle.topX + ',' + triangle.topY + ' ' + triangle.leftX + ',' + triangle.leftY + ' ' + triangle.rightX + ',' + triangle.rightY) });


	                //Show the legend in top left corner
	                var controlsInfo = [
	                    //{ id: 'c1', action: 'Add Leaf : ', buttons: ' Click on a Node', x: 5, y: 15 },
	                    //{ id: 'c2', action: 'Remove Leaf : ', buttons: ' Hold Ctrl & Click on a Leaf', x: 5, y: 30 },
	                    //{ id: 'c3', action: 'Change Node Text : ', buttons: ' Hold Shift & Click on a Node', x: 5, y: 45 }
	                ];
	                d3.select('#svgTree').append('g').attr('id', 'legend').selectAll('text').data(controlsInfo)
	                    .enter().append('text').attr('id', function (c) { return c.id; })
	                    .attr('x', function (c) { return c.x; }).attr('y', function (c) { return c.y; }).text(function (c) { return c.action; })
	                    .attr('style', 'font-size:6; fill:black;').append('tspan').attr('x', 100).attr('y', function (c) { return c.y; }).text(function (c) { return c.buttons; });
	                    
	                 

	                //Easy buttons at the bottom of the page
	               /* d3.select(".tree-one")
	                    .append("button")
	                    .html("Export")
	                    .on("click", svgToImage);

	                d3.select(".tree-one")
	                    .append("button")
	                    .html("Save")
	                    .on("click", saveTree);

	                d3.select("div")
	                    .append("button")
	                    .html("Load")
	                    .on("click", loadTree);

	                d3.select(".tree-one")
	                    .append("button")
	                    .html("Reset")
	                    .on("click", resetTree);

	                d3.select(".tree-one")
	                    .append("button")
	                    .html("Depth")
	                    .on("click", function () { if (uniformDepth) { uniformDepth = false; } else { uniformDepth = true; } reposition(tree.nodes[0]); redraw(); } );
					*/
	                redraw();
	            }

	            initialise();

	            return tree;
	        }
	        var tree = tree();

	    </script>

	    </div>

	   <div class = "tree-two" style="display: table-cell;">
	    <script class = "js-tree-two">

	        function tree2 () {

	        	var devide = 2;

	            var svgWidth = 1200/2,
	                svgHeight = 600/2;

	            var tree2 = {
	                cx: 600/2,
	                cy: 30/2,
	                w: 100,
	                h: 60/1.5,
	                size: 1/2,
	                leafDepth: Infinity,
	                nodes_two: []
	            };

	            var uniformDepth = true;
	            var addNode = false;
	            var removeNode = false;
	            var changeText = false;
	            var svgNodes;

	            var JSONDatatwo;

	          
	            //get the nodes
	            tree2.getNodes = function () {
	                var n_two = [];
	                function getNodes(node) {
	                    n_two.push({ id: node.id, text: node.text, x: node.x, y: node.y, kids: node.kids, isLeaf: node.isLeaf, tWidth: node.tWidth });
	                    node.kids.forEach(function (kid) { return getNodes(kid); });
	                }
	                getNodes(tree2.nodes_two[0]);
	                return n_two.sort(function (a, b) { return a.id - b.id; });
	            }

	            //get the links
	            tree2.getLinks = function () {
	                var l_two = [];
	                function getLinks(node) {
	                    node.kids.forEach(function (kid) { if (!kid.isLeaf) { l_two.push({ fromId: node.id, fromX: node.x, fromY: node.y, toId: kid.id, toX: kid.x, toY: kid.y }); } });
	                    node.kids.forEach(getLinks);
	                }
	                getLinks(tree2.nodes_two[0]);
	                return l_two.sort(function (a, b) { return a.toId - b.toId });
	            }

	            //get the triangles -- size of the trees
	            tree2.getTriangles = function () {
	                var t_two = [];
	                function getTriangles(node) {
	                    node.kids.forEach(function (kid) { if (kid.isLeaf) { t_two.push({ fromId: node.id, toId: kid.id, topX: node.x, topY: (node.y + 10/2), leftX: (kid.x - (kid.tWidth / 4)), leftY: (kid.y - 10/2), rightX: (kid.x + (kid.tWidth / 4)), rightY: (kid.y - 10/2) }); } });//10
	                    node.kids.forEach(getTriangles);
	                }
	                getTriangles(tree2.nodes_two[0]);
	                return t_two.sort(function (a, b) { return a.toId - b.toId });
	            }

	            //returns node object from nodes array
	            tree2.getNode = function (thisNode) {
	                var n_two;
	                //console.log('thisNode');
	                //console.log(thisNode);
	                function getNode(node) {
	                    if (node.id == thisNode.id) { n_two = node; }
	                    node.kids.forEach(getNode);
	                }
	                getNode(tree2.nodes_two[0]);
	                //console.log('n');
	                //console.log(n);
	                return n_two;
	            }

	            //get text width of node
	/*            tree.getTextWidth = function (node) {
	                var n = tree.getNode(node);
	                var nodes = d3.select('text#' + n.id);
	                n.tWidth = nodes.node().getBBox().width;
	                return nodes.node().getBBox().width;
	            }
	*/
	            //add a new leaf
	            tree2.addLeaf = function (parent) {
	                tree2.size++;
	                function addLeaf(node) {
	                    if (node.id == parent) {
	                        console.log('id' + (tree2.size - 1)); node.kids.push({ id: 'id' + (tree2.size - 1), text: 'Node ' + (tree2.size - 1), x: node.x, y: node.y, kids: [], isLeaf: true, tWidth: 0 }); node.isLeaf = false;
	                        refresh2();
	                        reposition2(tree2.nodes_two[0]);
	                        redraw2(); return;
	                    }
	                    node.kids.forEach(addLeaf);
	                }
	                addLeaf(tree2.nodes_two[0]);
	//                reposition(tree.nodes[0]);
	//                redraw();

	            }

	            //remove leaf
	            tree2.removeLeaf = function (nodeClicked) {
	                var parent_two = tree2.nodes_two[0];
	                var visited_two = [];
	                function removeLeaf(p) {
	                    function arrangeKids(index, numOfKids) {
	                        parent_two.kids.splice(index, 1);
	                        if (parent_two.kids.length == 0) { parent_two.isLeaf = true; }

	                        //console.log(parent.kids);

	                    }
	                    if (p.id == parent_two.id) {
	                        for (var i = 0; i < parent_two.kids.length; i++) {
	                            if (parent_two.kids[i].id == nodeClicked.id) {
	                                arrangeKids(i, parent_two.kids.length);
	                                reposition2(tree2.nodes_two[0]);
	                                redraw2();
	                                return;
	                            }
	                        }
	                    }
	                    p.kids.forEach(removeLeaf);
	                }
	                function findParent(node) { //finds the parent object of the leaf clicked and saves it to parent variable
	                    visited_two.push(node);
	                    if (node.id == nodeClicked.id) { visited_two.pop(); parent = visited_two[visited_two.length - 1]; removeLeaf(tree2.nodes_two[0]); }
	                    else {
	                        node.kids.forEach(findParent);
	                        visited_two.pop(); //remove nodes down visited paths
	                    }

	                    //console.log(visited);
	                }

	                if (nodeClicked.isLeaf) {
	                    findParent(tree2.nodes_two[0]);
	                }
	                refresh2();
	                reposition2(tree2.nodes_two[0]);
	                redraw2();
	            }

	            //change node text
	            tree2.changeText = function (node) {
	                var newText = '';
	                var num = 0;
	                var textBox = d3.select("#nodes_two").append("foreignObject").attr("x", node.x + 50).attr("y", node.y)
	                                .attr("width", 200).attr("height", 25).append("xhtml:form")
	                                .append("input").attr("value", function () { this.focus(); return node.text })
	                                .on("blur", function () {
	                                    newText = textBox.node().value;
	                                    function changeText(n) {
	                                        if (n.id == node.id) {
	                                            n.text = newText;
	                                            /*var nodes = d3.select('text#' + n.id);
	                                            nodes.text(newText);
	                                            //tree.getTextWidth(n);
	                                            nodes.attr('tWidth', tree.getTextWidth(n));
	                                            reposition(tree.nodes[0]);
	                                            */
	                                            refresh();
	                                            redraw();
	                                           return;
	                                        }
	                                        n.kids.forEach(changeText);
	                                    }
	                                    changeText(tree2.nodes_two[0]);
	                                    redraw();
	                                    d3.select("foreignObject").remove();
	                                    
	                                })
	                                .on("keypress", function () { 
	                                    if (d3.event.keyCode == 13) {
	                                        var e = d3.event;
	                                        //prevents the entire tree from deleting when enter is pressed
	                                        if (e.stopPropagation) { e.stopPropagation(); }
	                                        e.preventDefault();

	                                        newText = textBox.node().value;
	                                        function changeText(n) {
	                                            if (n.id == node.id) {
	                                                n.text = newText;
	                                                /*var nodes = d3.select('text#' + n.id);
	                                                nodes.text(newText);
	                                                //tree.getTextWidth(n);
	                                                nodes.attr('tWidth', tree.getTextWidth(n));
	                                                reposition(tree.nodes[0]);
	                                                */
	                                                refresh();
	                                                redraw();
	                                                return;
	                                            }
	                                            n.kids.forEach(changeText);
	                                        }
	                                        changeText(tree2.nodes_two[0]);
	                                        redraw();
	                                        d3.select("foreignObject").remove();
	                                    }
	                                });
	                //tree.getTextWidth(node);
	            }

	            //sets leafs depth to deepest leaf
	            tree2.nodeDepth = function () {
	                var leafs_two = [];
	                var depth_two = 0;
	                
	                //check if nodes are leafs
	                function nodeDepth(n) {
	                    n.kids.forEach(function (kid) {
	                        if (kid.isLeaf) { leafs_two.push({ id: kid.id });
	                            if (kid.y > depth_two) { depth_two = kid.y; }
	                        }
	                    });
	                    n.kids.forEach(nodeDepth);
	                }
	                nodeDepth(tree2.nodes_two[0]);
	                function changeDepth(n) {
	                    n.kids.forEach(function (kid) {
	                        leafs_two.forEach(function (leaf) { if (kid.id == leaf.id) { kid.y = depth_two; } })
	                        
	                    });
	                    n.kids.forEach(changeDepth);
	                }
	                changeDepth(tree2.nodes_two[0]);
	                tree2.leafDepth = depth_two;
	            }

	            //update/refresh svg
	            refresh2 = function () {
	                d3.select('#nodes_two').selectAll('text').data(tree2.getNodes()).remove();
	                d3.select('#links_two').selectAll('line').data(tree2.getLinks()).remove();
	                d3.select('#triangles_two').selectAll('polygon').data(tree2.getTriangles()).remove();
	            }

	            //redraw the tree
	            redraw2 = function () {
	                d3.select('#nodes_two').selectAll('text').data(tree2.getNodes()).exit().remove();
	                d3.select('#links_two').selectAll('line').data(tree2.getLinks()).exit().remove();
	                d3.select('#triangles_two').selectAll('polygon').data(tree2.getTriangles()).exit().remove();
	  
	                var nodes = d3.select('#nodes_two').selectAll('text').data(tree2.getNodes());

	                nodes.text(function (node) { return node.text })/*.transition().duration(500)*/
	                    .attr('x', function (node) { return node.x; }).attr('y', function (node) { return node.y + 5; })//5
	                    .attr('fill', function (node) { if (node.isLeaf) { return 'red'; } else { return 'blue'; } });

	                nodes.enter().append('text').attr('id', function (node) { console.log('id = ' + node.id); return node.id; })
	                    .attr('x', function (node) { return node.x; }).attr('y', function (node) { return node.y + 5; })
	                    .text(function (node) { return node.text; }) 
	                    .attr('tWidth', function (node) {
	                        var n = tree2.getNode(node); n.tWidth = this.getBBox().width; return this.getBBox().width;
	                    })
	                    .style({ 'text-anchor': 'middle', 'cursor': 'pointer' })
	                    .on('click', function (node) { if (d3.event.shiftKey) { return tree2.changeText(node); } else if (d3.event.ctrlKey) { return tree2.removeLeaf(node); } else { return tree2.addLeaf(node.id); } })
	                    /*.transition().duration(500)*/
	                    .attr('x', function (node) { return node.x; }).attr('y', function (node) { return node.y + 5; });


	                var links = d3.select('#links_two').selectAll('line').data(tree2.getLinks());

	                links/*.transition().duration(500)*/
	                    .attr('x1', function (link) { return link.fromX; }).attr('y1', function (link) { return link.fromY + 10; })//10
	                    .attr('x2', function (link) { return link.toX; }).attr('y2', function (link) { return link.toY - 10; });

	                links.enter().append('line')
	                    .attr('x1', function (link) { return link.fromX; }).attr('y1', function (link) { return link.fromY + 10; })
	                    .attr('x2', function (link) { return link.toX; }).attr('y2', function (link) { return link.toY - 10; })
	                    .style({ 'stroke': 'black', 'stroke-width': '1px' })
	                    /*.transition().duration(500)*/
	                    .attr('x2', function (link) { return link.toX; }).attr('y2', function (link) { return link.toY - 10; });

	                    
	                var triangles = d3.select('#triangles_two').selectAll('polygon').data(tree2.getTriangles());

	                triangles/*.transition().duration(500)*/
	                    .attr('points', function (triangle) { return (triangle.topX + ',' + triangle.topY + ' ' + triangle.leftX + ',' + triangle.leftY + ' ' + triangle.rightX + ',' + triangle.rightY) });

	                triangles.enter().append('polygon')
	                    .attr('points', function (triangle) { return (triangle.topX + ',' + triangle.topY + ' ' + triangle.leftX + ',' + triangle.leftY + ' ' + triangle.rightX + ',' + triangle.rightY) })
	                    .style({ 'stroke': 'black', 'stroke-width': '1px', 'fill': 'white' })
	                    /*.transition().duration(500)*/
	                    .attr('points', function (triangle) { return (triangle.topX + ',' + triangle.topY + ' ' + triangle.leftX + ',' + triangle.leftY + ' ' + triangle.rightX + ',' + triangle.rightY) });


	            }

	            //get leaf count for node
	            getLeafCount2 = function (node) {
	                if (node.kids.length == 0) { return 1; }
	                else { return node.kids.map(getLeafCount).reduce(function (a, b) { return a + b; }); }
	            }

	            //update node positions
	            reposition2 = function (node) {

	                if (uniformDepth) {
	                    tree2.nodeDepth();
	                }

	                var leafCount = getLeafCount(node),
	                    left = node.x - tree2.w * (leafCount - 1) / 2;
	                node.kids.forEach(function (kid) {
	                    var w = tree2.w * getLeafCount(kid);
	                    left += w;
	                    kid.x = left - (w + tree2.w) / 2;
	                    kid.y = node.y + tree2.h;
	                    reposition2(kid);
	                    redraw2();
	                });
	                
	            }

	            //convert svgTree to image 
	            svgToImage2 = function () {
	                //get svg element.
	                var svg = d3.select("svg")[0][0];
	                
	                //'remove' the legend in the top left corner
	                d3.select('text#c1').attr('style', 'fill:white;');
	                d3.select('text#c2').attr('style', 'fill:white;');
	                d3.select('text#c3').attr('style', 'fill:white;');

	                //get svg source.
	                var serializer = new XMLSerializer();
	                var source = serializer.serializeToString(svg);

	                //add name spaces.
	                if (!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)) {
	                    source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
	                }
	                if (!source.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)) {
	                    source = source.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
	                }

	                //add xml declaration
	                source = '<?xml version="1.0" standalone="no"?>\r\n' + source;

	                //convert svg source to URI data scheme.
	                var url = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(source);

	                //open the image in a new tab
	                var win = window.open(url, '_blank');

	                //make the legned visible again
	                d3.select('text#c1').attr('style', 'font-size:6; fill:black;');
	                d3.select('text#c2').attr('style', 'font-size:6; fill:black;');
	                d3.select('text#c3').attr('style', 'font-size:6; fill:black;');

	                win.focus();
	            }

	            //save the tree structure as JSON
	            saveTree2 = function () {
	                console.log(tree2.nodes_two);
	                JSONDatatwo = JSON.stringify(tree2.nodes_two);
	                console.log(JSONDatatwo);
	            }

	            //save the tree structure as JSON
	            loadTree2 = function () {
	                tree2.nodes_two = JSON.parse(JSONDatatwo);
	                console.log(tree2.nodes_two);
	                refresh2();
	                reposition2(tree2.nodes_two[0]);
	                redraw2();
	            }

	            resetTree2 = function () {
	                tree2.nodes_two = [];
	                tree2.nodes_two.push({ id: '00', text: 'Right Tree', x: tree2.cx, y: tree2.cy, kids: [], isLeaf: false, tWidth: 0 });
	                console.log(tree2.nodes_two);
	                refresh2();
	                reposition2(tree2.nodes_two[0]);
	                redraw2();
	            }

	            //set up the page
	            initialise2 = function () {


	                //add the root node
	                tree2.nodes_two.push({ id: '00', text: 'Right Tree', x: tree2.cx, y: tree2.cy, kids: [], isLeaf: false, tWidth: 0 });

	                //create the svg
	                d3.select(".tree-two").style().append('svg').attr('width', svgWidth).attr('height', svgHeight).attr('id', 'svgTree-two')
	                    ;

	                //create group of nodes
	                d3.select('#svgTree-two').append('g').attr('id', 'nodes_two').selectAll('text').data(tree2.getNodes())
	                    .enter().append('text').attr('id', function (node) { return node.id; })
	                    .attr('x', function (node) { return node.x; }).attr('y', function (node) { return node.y + 5; })
	                    .text(function (node) { return node.text; })
	                    .attr('tWidth', function (node) { var n = tree2.getNode(node); n.tWidth = this.getBBox().width; return this.getBBox().width; /*return tree.getTextWidth(node);*/ })
	                    .style({ 'text-anchor': 'middle', 'cursor': 'pointer' })
	                    .on('click', function (node) { return tree2.addLeaf(node.id); });

	                //create group of links
	                d3.select('#svgTree-two').append('g').attr('id', 'links_two').selectAll('line').data(tree2.getLinks())
	                    .enter().append('line')
	                    .attr('x1', function (link) { return link.fromX; }).attr('y1', function (link) { return link.fromY; })
	                    .attr('x2', function (link) { return link.toX; }).attr('y2', function (link) { return link.toY; });
	       
	                //create group of triangles
	                d3.select('#svgTree-two').append('g').attr('id', 'triangles_two').selectAll('polygon').data(tree2.getTriangles())
	                    .enter().append('polygon')
	                    .attr('points', function (triangle) { return (triangle.topX + ',' + triangle.topY + ' ' + triangle.leftX + ',' + triangle.leftY + ' ' + triangle.rightX + ',' + triangle.rightY) });


	                //Show the legend in top left corner
	                var controlsInfo = [
	                    //{ id: 'c1', action: 'Add Leaf : ', buttons: ' Click on a Node', x: 5, y: 15 },
	                    //{ id: 'c2', action: 'Remove Leaf : ', buttons: ' Hold Ctrl & Click on a Leaf', x: 5, y: 30 },
	                    //{ id: 'c3', action: 'Change Node Text : ', buttons: ' Hold Shift & Click on a Node', x: 5, y: 45 }
	                ];
	                d3.select('#svgTree-two').append('g').attr('id', 'legend').selectAll('text').data(controlsInfo)
	                    .enter().append('text').attr('id', function (c) { return c.id; })
	                    .attr('x', function (c) { return c.x; }).attr('y', function (c) { return c.y; }).text(function (c) { return c.action; })
	                    .attr('style', 'font-size:6; fill:black;').append('tspan').attr('x', 100).attr('y', function (c) { return c.y; }).text(function (c) { return c.buttons; });
	                    
	                 

	                //Easy buttons at the bottom of the page
	                /*d3.select(".tree-two")
	                    .append("button")
	                    .html("Export")
	                    .on("click", svgToImage2);

	                d3.select(".tree-two")
	                    .append("button")
	                    .html("Save")
	                    .on("click", saveTree2);

	                d3.select(".tree-two")
	                    .append("button")
	                    .html("Load")
	                    .on("click", loadTree2);

	                d3.select(".tree-two")
	                    .append("button")
	                    .html("Reset")
	                    .on("click", resetTree2);

	                d3.select(".tree-two")
	                    .append("button")
	                    .html("Depth")
	                    .on("click", function () { if (uniformDepth) { uniformDepth = false; } else { uniformDepth = true; } reposition(tree2.nodes_two[0]); redraw2(); } );
	*/
	                redraw2();
	            }

	            initialise2();

	            return tree2;
	        }
	        var tree2 = tree2();

	    </script>

	    </div>
	    </div>
    </div>
   		<input id="left" type="button" value="SaveTree-left" onclick="saveTree();" />
		<input id="left" type="button" value="LoadTree-left" onclick="loadTree();" />
		<input id="left" type="button" value="ResetTree-left" onclick="resetTree();" />

		<input id="right" type="button" value="SaveTree-right" onclick="saveTree2();" />
		<input id="right" type="button" value="LoadTree-right" onclick="loadTree2();" />
		<input id="right" type="button" value="ResetTree-right" onclick="resetTree2();" />


</body>
</html>